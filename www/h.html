<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>


<!-- kilde: http://lucidworks.com/blog/easy-hierarchical-faceting-and-display-with-solr-and-jquery-and-a-tiny-bit-of-python/ -->

$(document).ready(function(){

	$('#form').submit(function(){
	    $.ajax({
	      url: $('#form').attr('action'),
	      data : $('#form').serialize(),
	      success: function(data,status,jqXHR){
		console.log('form submitted.');
                listCats(jQuery.parseJSON(data));
	      }
	    });
	    return false;
	});

      var toggleCat = function() {
          if ( jQuery(this).hasClass('expanded') ) {
            /*console.log("collapsing:");
            console.log(jQuery(this));*/
          jQuery(this).removeClass('expanded');
          jQuery(this).addClass('collapsed').text('+')
            .parent().children('ul').remove();
        } else {
          /*console.log("Expanding:");
          console.log(jQuery(this));*/
          list_item = jQuery(this).removeClass('collapsed').addClass('expanded').text('-').parent();
          var depth = parseInt(list_item.attr('class').split('-', 2)[1]);
          var fq = '{!raw f=location}'+escape(depth+'/'+list_item.find('.catName').text());
          var request = request_data;
          request['facet.prefix'] = depth+1+'/';
          jQuery.getJSON(url+'&fq='+fq, request, function(data){appendCats(list_item, data);});
        }
      }
      var appendCats = function( list_item, data ) {
        var list = jQuery('<ul class="facet-list" style="margin-left: 1em"></ul>');
        catList(list, data);
        list_item.append(list);
        list.find('.expand').click( toggleCat ).css({cursor:'pointer', display:'inline-block', width:'1em'});
      }
      var catList = function( list, data ) {
        var item = '';
        var link = '';
        var catName = '';
        var count = 0;
alert(data);
        for ( var i = 0; i < data.facet_counts.facet_fields.location.length; i=i+2 ) {
          catDepth = data.facet_counts.facet_fields.location[i].split('/',2)[0];
          catName = data.facet_counts.facet_fields.location[i].split('/',2)[1];
          count = data.facet_counts.facet_fields.location[i+1];
          link = window.location.href+'&fq={!raw f=location}'+escape(data.facet_counts.facet_fields.location[i]);
          item = '<li class="depth-'+catDepth+'"><span class="expand collapsed" id="span-depth-'+catDepth +'">+</span>';
          item += '<a href="'+link+'">';
          item += '<span class="catName">'+catName+'</span> <span class="catCount">('+count+')</span>';
          item += '</a>';
          item += '</li>';
          list.append(jQuery(item));
        }
      }

   var listCats = function( data ) {
     var list = jQuery('<ul class="facet-list"></ul>');
     catList(list, data);
     list = jQuery('<div class="facet facet-taxonomy"></div>').append(list);
     jQuery('#hierarchy').before(list).prev()
     .find('.expand').click( toggleCat ).css({cursor:'pointer', display:'inline-block', width:'1em'});
   }
   var request_data = {
      wt: 'json'
   };
   var url = "http://localhost:8983/solr/collection1/select?q=*%3A*&facet=true&facet.field=location";
   the_response = jQuery.getJSON(url, request_data, listCats);
   //alert(the_response);
});
</script>
</head>
<body>

<form name="example" action="/solr/collection1/select" id="form" >
  <input type="text" name="q">
  <input type="hidden" name="facet" value="true">
  <input type="hidden" name="facet.field" value="location">
  <input type="hidden" name="wt" value="json">
  <input type="submit" value="Submit">
</form> 
<div id="hierarchy"> </div>

</body>
</html>
